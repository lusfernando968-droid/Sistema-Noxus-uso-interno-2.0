<!DOCTYPE html>
<html>
<head>
    <title>Debug Console - Teste de Banco</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f5f5f5; }
        .console { background: #000; color: #0f0; padding: 15px; border-radius: 5px; min-height: 300px; margin: 10px 0; }
        .button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 3px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
    </style>
</head>
<body>
    <h1>üêõ Debug Console - Teste de Inser√ß√£o de Banco</h1>
    
    <div>
        <button class="button" onclick="runFullTest()">üöÄ Executar Teste Completo</button>
        <button class="button" onclick="checkAuth()">üîê Verificar Autentica√ß√£o</button>
        <button class="button" onclick="checkExistingBanks()">üìã Verificar Bancos</button>
        <button class="button" onclick="testInsertBank()">üíæ Testar Inser√ß√£o</button>
        <button class="button" onclick="clearConsole()">üóëÔ∏è Limpar Console</button>
    </div>
    
    <div id="console" class="console"></div>
    
    <div>
        <h3>Instru√ß√µes:</h3>
        <ol>
            <li>Abra o sistema normalmente e fa√ßa login</li>
            <li>Abra esta p√°gina em uma nova aba</li>
            <li>Clique em "Executar Teste Completo"</li>
            <li>Verifique os resultados no console abaixo</li>
        </ol>
    </div>

    <script>
        // Configura√ß√£o do Supabase (mesma do seu projeto)
        const SUPABASE_URL = 'https://kkmnhpbbkkrkwbgnqxfy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrbW5ocGJia2tya3diZ25xeGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE0NTQxMzUsImV4cCI6MjA0NzAzMDEzNX0.1WQ3LVALE3q2W3fN3XaQhL3Xb3xZ3Y3Z3Y3Z3Y3Z3Y3Z';
        
        let supabaseClient = null;
        
        // Inicializar Supabase
        function initSupabase() {
            try {
                // Tenta importar do script principal
                if (typeof window.supabase !== 'undefined') {
                    supabaseClient = window.supabase;
                    log('‚úÖ Supabase encontrado no window', 'success');
                    return true;
                }
                
                // Se n√£o encontrar, tenta criar uma inst√¢ncia
                log('‚ö†Ô∏è Supabase n√£o encontrado, tentando criar inst√¢ncia...', 'warning');
                
                // Criar cliente manualmente
                supabaseClient = {
                    from: (table) => ({
                        select: (columns = '*') => ({
                            eq: (column, value) => ({
                                single: async () => {
                                    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${value}&select=${columns}`, {
                                        headers: {
                                            'apikey': SUPABASE_ANON_KEY,
                                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                        }
                                    });
                                    const data = await response.json();
                                    return { data: data[0], error: response.ok ? null : { message: response.statusText } };
                                }
                            }),
                            order: (column, { ascending }) => ({
                                then: async (callback) => {
                                    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${columns}&order=${column}.${ascending ? 'asc' : 'desc'}`, {
                                        headers: {
                                            'apikey': SUPABASE_ANON_KEY,
                                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                        }
                                    });
                                    const data = await response.json();
                                    return callback({ data, error: response.ok ? null : { message: response.statusText } });
                                }
                            })
                        }),
                        insert: (values) => ({
                            select: () => ({
                                single: async () => {
                                    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                                        method: 'POST',
                                        headers: {
                                            'apikey': SUPABASE_ANON_KEY,
                                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                            'Content-Type': 'application/json',
                                            'Prefer': 'return=representation'
                                        },
                                        body: JSON.stringify(values[0])
                                    });
                                    const data = await response.json();
                                    return { data: data[0], error: response.ok ? null : { message: response.statusText, details: await response.text() } };
                                }
                            })
                        })
                    })
                };
                
                log('‚úÖ Cliente Supabase criado manualmente', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå Erro ao inicializar Supabase: ${error.message}`, 'error');
                return false;
            }
        }
        
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            console.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }
        
        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }
        
        async function checkAuth() {
            log('üîê Verificando autentica√ß√£o...');
            
            try {
                // Tenta obter o usu√°rio da aba principal
                if (window.opener && window.opener.supabase) {
                    const { data: { user }, error } = await window.opener.supabase.auth.getUser();
                    if (user) {
                        log(`‚úÖ Usu√°rio autenticado na aba principal: ${user.email}`, 'success');
                        return true;
                    }
                }
                
                log('‚ö†Ô∏è N√£o foi poss√≠vel verificar autentica√ß√£o', 'warning');
                return false;
                
            } catch (error) {
                log(`‚ùå Erro ao verificar autentica√ß√£o: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function checkExistingBanks() {
            log('üìã Verificando bancos existentes...');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/bancos?select=codigo,nome_curto&order=codigo`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (response.ok) {
                    const bancos = await response.json();
                    log(`‚úÖ Encontrados ${bancos.length} bancos:`, 'success');
                    
                    bancos.slice(0, 10).forEach(banco => {
                        log(`   ${banco.codigo}: ${banco.nome_curto}`);
                    });
                    
                    if (bancos.length > 10) {
                        log(`   ... e mais ${bancos.length - 10} bancos`);
                    }
                    
                    return bancos;
                } else {
                    log(`‚ùå Erro ao buscar bancos: ${response.status}`, 'error');
                    return [];
                }
                
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
                return [];
            }
        }
        
        async function testInsertBank() {
            log('üíæ Iniciando teste de inser√ß√£o...');
            
            // Verificar bancos existentes primeiro
            const existingBanks = await checkExistingBanks();
            
            // Encontrar c√≥digo dispon√≠vel
            let testCode = '996';
            let counter = 995;
            while (existingBanks.some(b => b.codigo === testCode) && counter > 900) {
                testCode = counter.toString();
                counter--;
            }
            
            const testBank = {
                nome_curto: "Banco Debug Teste",
                nome: "Banco Debug Teste S.A.",
                codigo: testCode,
                cor_primaria: "#FF5733",
                ativo: true
            };
            
            log(`üìä Tentando inserir com c√≥digo ${testCode}...`);
            log(`üìù Dados: ${JSON.stringify(testBank)}`);
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/bancos`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(testBank)
                });
                
                const responseText = await response.text();
                log(`üì° Status: ${response.status} - ${response.statusText}`);
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log(`‚úÖ Banco inserido com sucesso! ID: ${data[0]?.id}`, 'success');
                        log(`üìä Dados: ${JSON.stringify(data[0])}`);
                    } catch (e) {
                        log(`‚úÖ Banco inserido! Resposta: ${responseText}`, 'success');
                    }
                } else {
                    log(`‚ùå Erro na inser√ß√£o`, 'error');
                    log(`üìÑ Resposta: ${responseText}`, 'error');
                    
                    // Analisar erro espec√≠fico
                    if (response.status === 401) {
                        log('üö´ Erro de autentica√ß√£o', 'error');
                    } else if (response.status === 403) {
                        log('üö´ Erro de permiss√£o - RLS ou pol√≠ticas restritivas', 'error');
                    } else if (response.status === 409) {
                        log('‚ö†Ô∏è Conflito - c√≥digo ou nome duplicado', 'error');
                    } else if (response.status === 400) {
                        log('üìã Erro de valida√ß√£o', 'error');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro geral: ${error.message}`, 'error');
            }
        }
        
        async function runFullTest() {
            clearConsole();
            log('üöÄ EXECUTANDO TESTE COMPLETO', 'success');
            
            await checkAuth();
            await checkExistingBanks();
            await testInsertBank();
            
            log('üèÅ Teste completo finalizado', 'success');
        }
        
        // Inicializar quando a p√°gina carregar
        window.addEventListener('load', () => {
            initSupabase();
            log('üéØ Debug Console carregada', 'success');
            log('üí° Clique nos bot√µes acima para executar os testes');
        });
        
        // Disponibilizar fun√ß√µes globalmente
        window.debugFunctions = {
            runFullTest,
            checkAuth,
            checkExistingBanks,
            testInsertBank,
            clearConsole
        };
        
    </script>
</body>
</html>