<!DOCTYPE html>
<html>
<head>
    <title>Teste de Inser√ß√£o de Banco - Debug</title>
</head>
<body>
    <h1>üîç Debug de Inser√ß√£o de Banco</h1>
    <button onclick="testInsert()">üß™ Testar Inser√ß√£o</button>
    <button onclick="checkAuth()">üîê Verificar Autentica√ß√£o</button>
    <button onclick="checkExistingCodes()">üìã Verificar C√≥digos Existentes</button>
    <div id="resultado" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;"></div>

    <script>
        const SUPABASE_URL = 'https://kkmnhpbbkkrkwbgnqxfy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrbW5ocGJia2tya3diZ25xeGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE0NTQxMzUsImV4cCI6MjA0NzAzMDEzNX0.1WQ3LVALE3q2W3fN3XaQhL3Xb3xZ3Y3Z3Y3Z3Y3Z3Y3Z';

        function log(message, type = 'info') {
            const resultado = document.getElementById('resultado');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            resultado.innerHTML += `<div style="color: ${color}; margin: 5px 0;">üìù ${new Date().toLocaleTimeString()}: ${message}</div>`;
        }

        async function checkAuth() {
            log('üîê Verificando autentica√ß√£o...');
            
            try {
                // Verificar sess√£o atual
                const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    log(`‚úÖ Usu√°rio autenticado: ${user.email || user.id}`, 'success');
                    return true;
                } else {
                    log('‚ö†Ô∏è Nenhum usu√°rio autenticado encontrado', 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erro ao verificar autentica√ß√£o: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkExistingCodes() {
            log('üìã Verificando c√≥digos de banco existentes...');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/bancos?select=codigo,nome_curto`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (response.ok) {
                    const bancos = await response.json();
                    log(`‚úÖ Encontrados ${bancos.length} bancos`, 'success');
                    bancos.slice(0, 5).forEach(banco => {
                        log(`   - ${banco.codigo}: ${banco.nome_curto}`);
                    });
                    
                    // Verificar se c√≥digo 998 j√° existe
                    const exists = bancos.some(b => b.codigo === '998');
                    if (exists) {
                        log('‚ö†Ô∏è C√≥digo 998 j√° existe! Use um c√≥digo diferente.', 'error');
                    }
                    
                    return bancos;
                } else {
                    log(`‚ùå Erro ao buscar bancos: ${response.status}`, 'error');
                    return [];
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
                return [];
            }
        }

        async function testInsert() {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = '';
            
            log('üöÄ Iniciando teste de inser√ß√£o...');
            
            // Primeiro verificar autentica√ß√£o
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                log('‚ùå Necess√°rio estar autenticado para inserir', 'error');
                return;
            }
            
            // Verificar c√≥digos existentes
            const existingBanks = await checkExistingCodes();
            
            // Encontrar c√≥digo dispon√≠vel
            let testCode = '998';
            let counter = 997;
            while (existingBanks.some(b => b.codigo === testCode) && counter > 900) {
                testCode = counter.toString();
                counter--;
            }
            
            const testBank = {
                nome_curto: "Banco Teste Debug",
                nome: "Banco Teste Debug S.A.",
                codigo: testCode,
                cor_primaria: "#FF0000",
                ativo: true
            };
            
            log(`üìù Tentando inserir com c√≥digo ${testCode}...`);
            log(`üìä Dados: ${JSON.stringify(testBank)}`);
            
            try {
                // Obter token de autentica√ß√£o real (se dispon√≠vel)
                const authResponse = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                let token = SUPABASE_ANON_KEY;
                if (authResponse.ok) {
                    // Se houver um usu√°rio autenticado, precisar√≠amos do token real
                    // Por enquanto, vamos usar o anon key
                    log('üîë Usando token de autentica√ß√£o');
                }
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/bancos`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(testBank)
                });
                
                const responseText = await response.text();
                log(`üì° Status: ${response.status} - ${response.statusText}`);
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log(`‚úÖ Banco inserido com sucesso! ID: ${data[0]?.id}`, 'success');
                        log(`üìä Dados retornados: ${JSON.stringify(data[0])}`);
                    } catch (e) {
                        log(`‚úÖ Banco inserido! Resposta: ${responseText}`, 'success');
                    }
                } else {
                    log(`‚ùå Erro na inser√ß√£o`, 'error');
                    log(`üìÑ Resposta: ${responseText}`, 'error');
                    
                    // Analisar erro espec√≠fico
                    if (response.status === 401) {
                        log('üö´ Erro de autentica√ß√£o - token inv√°lido', 'error');
                    } else if (response.status === 403) {
                        log('üö´ Erro de permiss√£o - RLS ou pol√≠ticas restritivas', 'error');
                    } else if (response.status === 409) {
                        log('‚ö†Ô∏è Conflito - c√≥digo ou nome duplicado', 'error');
                    } else if (response.status === 400) {
                        log('üìã Erro de valida√ß√£o - campos obrigat√≥rios', 'error');
                        try {
                            const errorData = JSON.parse(responseText);
                            log(`üí° Detalhes: ${JSON.stringify(errorData)}`);
                        } catch (e) {
                            log(`üí° Resposta: ${responseText}`);
                        }
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro geral: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>