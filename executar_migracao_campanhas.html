<!DOCTYPE html>
<html>
<head>
    <title>Executar Migra√ß√£o - Campanhas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .danger {
            background: #f44336;
        }
        .danger:hover {
            background: #da190b;
        }
        #resultado {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
        }
        .success {
            border-left-color: #4CAF50;
            background: #e8f5e9;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Executar Migra√ß√£o - Tabela Campanhas</h1>
        <p>Este script ir√° criar a tabela <code>campanhas</code> no banco de dados Supabase.</p>
        
        <button onclick="executarMigracao()">‚úÖ Executar Migra√ß√£o</button>
        <button onclick="verificarTabela()">üîç Verificar se Tabela Existe</button>
        <button onclick="testarCRUD()" class="danger">üß™ Testar CRUD (ap√≥s migra√ß√£o)</button>
        
        <div id="resultado"></div>
    </div>

    <script type="module">
        // Importar Supabase
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const SUPABASE_URL = 'https://kkmnhpbbkkrkwbgnqxfy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrbW5ocGJia2tya3diZ25xeGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE0NTQxMzUsImV4cCI6MjA0NzAzMDEzNX0.1WQ3LVALE3q2W3fN3XaQhL3Xb3xZ3Y3Z3Y3Z3Y3Z3Y3Z';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        window.resultado = document.getElementById('resultado');

        // SQL da migra√ß√£o
        const migrationSQL = `
-- Criar tabela campanhas para o m√≥dulo Marketing
create table if not exists public.campanhas (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  titulo text not null,
  objetivo text,
  publico_alvo text,
  canal text not null check (canal in ('INSTAGRAM', 'FACEBOOK', 'TIKTOK', 'GOOGLE_ADS', 'ORGANICO', 'EMAIL')),
  orcamento numeric,
  data_inicio date,
  data_fim date,
  status text not null default 'RASCUNHO' check (status in ('RASCUNHO', 'ATIVA', 'PAUSADA', 'ENCERRADA')),
  tags text[],
  notas text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Criar √≠ndice em user_id para otimizar queries
create index if not exists idx_campanhas_user_id on public.campanhas(user_id);

-- Habilitar Row Level Security (RLS)
alter table public.campanhas enable row level security;

-- Criar pol√≠ticas de acesso (usu√°rios autenticados podem gerenciar apenas suas pr√≥prias campanhas)
create policy "Usu√°rios podem ver suas pr√≥prias campanhas"
  on public.campanhas
  for select
  using (auth.uid() = user_id);

create policy "Usu√°rios podem criar suas pr√≥prias campanhas"
  on public.campanhas
  for insert
  with check (auth.uid() = user_id);

create policy "Usu√°rios podem atualizar suas pr√≥prias campanhas"
  on public.campanhas
  for update
  using (auth.uid() = user_id)
  with check (auth.uid() = user_id);

create policy "Usu√°rios podem deletar suas pr√≥prias campanhas"
  on public.campanhas
  for delete
  using (auth.uid() = user_id);

-- Criar fun√ß√£o para atualizar updated_at automaticamente
create or replace function public.handle_updated_at()
returns trigger as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;

-- Criar trigger para atualizar updated_at
drop trigger if exists set_updated_at on public.campanhas;
create trigger set_updated_at
  before update on public.campanhas
  for each row
  execute function public.handle_updated_at();
`;

        window.executarMigracao = async function() {
            resultado.innerHTML = '<p>üîÑ Executando migra√ß√£o SQL...</p>';
            
            try {
                // NOTA: A API REST do Supabase n√£o permite executar SQL diretamente por seguran√ßa
                // Voc√™ precisa executar isso via:
                // 1. Interface web do Supabase (SQL Editor)
                // 2. Supabase CLI: supabase db push
                // 3. Copiar e colar o SQL manualmente
                
                resultado.innerHTML = `
                    <div class="error">
                        <h3>‚ö†Ô∏è Execu√ß√£o Manual Necess√°ria</h3>
                        <p>Por raz√µes de seguran√ßa, o Supabase n√£o permite executar SQL arbitr√°rio via API REST.</p>
                        <p><strong>Siga um destes m√©todos:</strong></p>
                        <ol>
                            <li><strong>Via Interface Web:</strong>
                                <ul>
                                    <li>Acesse: <a href="https://supabase.com/dashboard/project/kkmnhpbbkkrkwbgnqxfy/editor" target="_blank">Supabase SQL Editor</a></li>
                                    <li>Copie o SQL abaixo</li>
                                    <li>Cole no editor e clique em "Run"</li>
                                </ul>
                            </li>
                            <li><strong>Via Supabase CLI:</strong>
                                <ul>
                                    <li>Execute: <code>supabase db push</code> (ir√° aplicar todas as migra√ß√µes)</li>
                                </ul>
                            </li>
                        </ol>
                        <h4>üìã SQL para copiar:</h4>
                        <pre>${migrationSQL}</pre>
                        <p>Ap√≥s executar o SQL, clique em "Verificar se Tabela Existe" para confirmar.</p>
                    </div>
                `;
            } catch (error) {
                resultado.innerHTML = `<div class="error"><p>‚ùå Erro: ${error.message}</p></div>`;
            }
        };

        window.verificarTabela = async function() {
            resultado.innerHTML = '<p>üîç Verificando se a tabela campanhas existe...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('campanhas')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    if (error.code === 'PGRST204' || error.message.includes('schema cache')) {
                        resultado.innerHTML = `
                            <div class="error">
                                <p>‚ùå Tabela <strong>campanhas</strong> N√ÉO existe ainda.</p>
                                <p>Execute a migra√ß√£o primeiro clicando no bot√£o "Executar Migra√ß√£o".</p>
                            </div>
                        `;
                    } else {
                        throw error;
                    }
                } else {
                    resultado.innerHTML = `
                        <div class="success">
                            <p>‚úÖ Tabela <strong>campanhas</strong> existe e est√° acess√≠vel!</p>
                            <p>Registros encontrados: ${data ? data.length : 0}</p>
                            <p>Voc√™ j√° pode usar a funcionalidade de campanhas no aplicativo.</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultado.innerHTML = `<div class="error"><p>‚ùå Erro ao verificar: ${error.message}</p></div>`;
            }
        };

        window.testarCRUD = async function() {
            resultado.innerHTML = '<p>üß™ Testando opera√ß√µes CRUD...</p>';
            
            try {
                // Tentar inserir uma campanha de teste
                const testCampanha = {
                    titulo: 'Campanha de Teste',
                    canal: 'INSTAGRAM',
                    status: 'RASCUNHO',
                    objetivo: 'Testar funcionalidade',
                    orcamento: 100
                };
                
                resultado.innerHTML += '<p>üìù Criando campanha de teste...</p>';
                const { data: inserted, error: insertError } = await supabase
                    .from('campanhas')
                    .insert(testCampanha)
                    .select()
                    .single();
                
                if (insertError) throw insertError;
                
                resultado.innerHTML += `<p>‚úÖ Campanha criada com ID: ${inserted.id}</p>`;
                
                // Testar leitura
                resultado.innerHTML += '<p>üìñ Lendo campanha...</p>';
                const { data: read, error: readError } = await supabase
                    .from('campanhas')
                    .select('*')
                    .eq('id', inserted.id)
                    .single();
                
                if (readError) throw readError;
                resultado.innerHTML += '<p>‚úÖ Leitura OK</p>';
                
                // Testar atualiza√ß√£o
                resultado.innerHTML += '<p>‚úèÔ∏è Atualizando campanha...</p>';
                const { error: updateError } = await supabase
                    .from('campanhas')
                    .update({ objetivo: 'Teste atualizado' })
                    .eq('id', inserted.id);
                
                if (updateError) throw updateError;
                resultado.innerHTML += '<p>‚úÖ Atualiza√ß√£o OK</p>';
                
                // Testar exclus√£o
                resultado.innerHTML += '<p>üóëÔ∏è Deletando campanha de teste...</p>';
                const { error: deleteError } = await supabase
                    .from('campanhas')
                    .delete()
                    .eq('id', inserted.id);
                
                if (deleteError) throw deleteError;
                
                resultado.innerHTML += `
                    <div class="success">
                        <p>‚úÖ <strong>Todos os testes passaram com sucesso!</strong></p>
                        <p>CREATE ‚úÖ | READ ‚úÖ | UPDATE ‚úÖ | DELETE ‚úÖ</p>
                        <p>A tabela campanhas est√° totalmente funcional.</p>
                    </div>
                `;
                
            } catch (error) {
                resultado.innerHTML += `
                    <div class="error">
                        <p>‚ùå Erro durante os testes: ${error.message}</p>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    </div>
                `;
            }
        };

        // Verificar automaticamente ao carregar a p√°gina
        window.addEventListener('load', () => {
            verificarTabela();
        });
    </script>
</body>
</html>
